# Komoditas ML Service\n\n> Machine Learning service untuk prediksi harga komoditas Indonesia dengan akurasi tinggi\n\n## üöÄ Overview\n\nKomoditas ML Service adalah layanan machine learning yang dirancang khusus untuk memprediksi harga komoditas strategis Indonesia. Service ini menggunakan kombinasi algoritma Prophet dan LSTM untuk forecasting, serta DBSCAN dan Isolation Forest untuk anomaly detection.\n\n### ‚ú® Key Features\n\n- **Time Series Forecasting**: Prophet + LSTM untuk prediksi harga dengan akurasi >85%\n- **Anomaly Detection**: Deteksi otomatis price spikes dan outliers geografis\n- **Real-time Inference**: Latency <100ms untuk prediksi real-time\n- **Weather Correlation**: Analisis korelasi harga dengan data cuaca\n- **Scalable Architecture**: Mendukung 8+ komoditas dan 34 provinsi\n- **Production Ready**: Docker containerization dengan monitoring\n\n## üèóÔ∏è Architecture\n\n```\n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n‚îÇ   FastAPI       ‚îÇ    ‚îÇ   ML Models     ‚îÇ    ‚îÇ   Data Sources  ‚îÇ\n‚îÇ   Application   ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   - Prophet     ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   - PostgreSQL  ‚îÇ\n‚îÇ   - Predictions ‚îÇ    ‚îÇ   - LSTM        ‚îÇ    ‚îÇ   - Redis Cache ‚îÇ\n‚îÇ   - Anomalies   ‚îÇ    ‚îÇ   - Isolation   ‚îÇ    ‚îÇ   - Feature     ‚îÇ\n‚îÇ   - Analytics   ‚îÇ    ‚îÇ   - DBSCAN      ‚îÇ    ‚îÇ     Store       ‚îÇ\n‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n```\n\n## üõ†Ô∏è Tech Stack\n\n### Core Technologies\n- **Framework**: Python 3.11 + FastAPI\n- **ML Libraries**: Prophet, TensorFlow, scikit-learn\n- **Database**: PostgreSQL + TimescaleDB\n- **Cache**: Redis\n- **Monitoring**: MLflow, Prometheus, Grafana\n\n### ML Models\n- **Prophet**: Baseline forecasting dengan seasonal patterns\n- **LSTM**: Advanced neural network untuk pola kompleks\n- **Isolation Forest**: Temporal anomaly detection\n- **DBSCAN**: Geographic anomaly detection\n\n## üöÄ Quick Start\n\n### Prerequisites\n\n- Docker & Docker Compose\n- Python 3.11+\n- PostgreSQL 15+\n- Redis 7+\n\n### 1. Clone Repository\n\n```bash\ngit clone <repository-url>\ncd komoditas-ml-service\n```\n\n### 2. Environment Setup\n\n```bash\n# Copy environment file\ncp .env.example .env\n\n# Edit configuration\nnano .env\n```\n\n### 3. Docker Development Setup\n\n```bash\n# Start all services\ndocker-compose up -d\n\n# Check service status\ndocker-compose ps\n\n# View logs\ndocker-compose logs -f ml-service\n```\n\n### 4. Alternative: Local Development\n\n```bash\n# Install dependencies\npip install -r requirements.txt\n\n# Run database migrations (if needed)\n# python -m alembic upgrade head\n\n# Start development server\npython -m uvicorn app.api.main:app --host 0.0.0.0 --port 8001 --reload\n```\n\n## üìä API Documentation\n\n### Base URL\n```\nLocal Development: http://localhost:8001\nProduction: https://your-domain.com\n```\n\n### Core Endpoints\n\n#### üîÆ Predictions\n\n```bash\n# Single commodity prediction\nPOST /api/v1/predict/price/{commodity_code}\n{\n    \"region_code\": \"31\",\n    \"horizon_days\": 7,\n    \"model_type\": \"prophet\",\n    \"include_uncertainty\": true\n}\n\n# Batch predictions\nPOST /api/v1/predict/batch\n{\n    \"requests\": [\n        {\n            \"commodity_code\": \"BERAS\",\n            \"region_code\": \"31\",\n            \"horizon_days\": 7\n        }\n    ]\n}\n```\n\n#### üö® Anomaly Detection\n\n```bash\n# Detect anomalies\nPOST /api/v1/predict/anomaly\n{\n    \"commodity_code\": \"BERAS\",\n    \"detection_type\": \"both\",\n    \"sensitivity\": 0.1,\n    \"time_window_days\": 30\n}\n\n# Regional anomalies\nGET /api/v1/predict/anomaly/{region_code}?commodity_code=BERAS\n```\n\n#### üìà Analytics\n\n```bash\n# Weather-price correlation\nPOST /api/v1/analytics/correlation\n{\n    \"commodity_code\": \"BERAS\",\n    \"weather_types\": [\"TEMPERATURE\", \"RAINFALL\"],\n    \"time_window_days\": 365\n}\n```\n\n#### üéØ Model Management\n\n```bash\n# Model performance\nGET /api/v1/models/accuracy?model_name=prophet&commodity_code=BERAS\n\n# Retrain models\nPOST /api/v1/models/retrain\n{\n    \"model_name\": \"prophet\",\n    \"commodity_codes\": [\"BERAS\"],\n    \"force_retrain\": true\n}\n```\n\n### Response Examples\n\n#### Prediction Response\n```json\n{\n    \"success\": true,\n    \"message\": \"Prediction completed successfully\",\n    \"commodity_code\": \"BERAS\",\n    \"commodity_name\": \"Beras\",\n    \"region_code\": \"31\",\n    \"model_type\": \"prophet\",\n    \"predictions\": [\n        {\n            \"date\": \"2024-12-08T00:00:00\",\n            \"predicted_price\": 12500.0,\n            \"lower_bound\": 11875.0,\n            \"upper_bound\": 13125.0,\n            \"confidence\": 0.85\n        }\n    ],\n    \"current_price\": 12000.0,\n    \"price_change_forecast\": 4.17,\n    \"trend_direction\": \"up\"\n}\n```\n\n#### Anomaly Response\n```json\n{\n    \"success\": true,\n    \"detection_type\": \"both\",\n    \"total_anomalies\": 2,\n    \"anomalies\": [\n        {\n            \"date\": \"2024-12-07T00:00:00\",\n            \"commodity_code\": \"BERAS\",\n            \"region_code\": \"31\",\n            \"actual_price\": 15000.0,\n            \"expected_price\": 12000.0,\n            \"anomaly_score\": 0.92,\n            \"anomaly_type\": \"price_spike\",\n            \"severity\": \"critical\",\n            \"explanation\": \"Harga naik 25% dalam sehari; Volatilitas tinggi (15%) dalam 7 hari terakhir\"\n        }\n    ]\n}\n```\n\n## üîß Configuration\n\n### Environment Variables\n\n| Variable | Description | Default |\n|----------|-------------|----------|\n| `DATABASE_URL` | PostgreSQL connection string | `postgresql://...` |\n| `REDIS_URL` | Redis connection string | `redis://localhost:6379/2` |\n| `PROPHET_SEASONALITY_MODE` | Prophet seasonality mode | `multiplicative` |\n| `LSTM_SEQUENCE_LENGTH` | LSTM sequence length | `30` |\n| `ISOLATION_FOREST_CONTAMINATION` | Anomaly contamination rate | `0.1` |\n| `MAX_PREDICTION_LATENCY_MS` | Max prediction latency | `100` |\n\n### Model Configuration\n\n```python\n# Prophet Model\nPROPHET_SEASONALITY_MODE = \"multiplicative\"\nPROPHET_YEARLY_SEASONALITY = True\nPROPHET_WEEKLY_SEASONALITY = True\n\n# LSTM Model\nLSTM_SEQUENCE_LENGTH = 30\nLSTM_HIDDEN_UNITS = 64\nLSTM_DROPOUT_RATE = 0.2\nLSTM_LEARNING_RATE = 0.001\n\n# Anomaly Detection\nISOLATION_FOREST_CONTAMINATION = 0.1\nDBSCAN_EPS = 0.5\nDBSCAN_MIN_SAMPLES = 5\n```\n\n## üß™ Model Training\n\n### Training Pipeline\n\n```python\nfrom app.training.trainer import ModelTrainer\n\n# Initialize trainer\ntrainer = ModelTrainer()\n\n# Train models for specific commodity\nresults = trainer.train_commodity_models(\n    commodity_code=\"BERAS\",\n    region_codes=[\"31\", \"32\"],\n    model_types=[\"prophet\", \"lstm\"],\n    retrain=True\n)\n\nprint(f\"Training results: {results}\")\n```\n\n### Feature Engineering\n\n- **Technical Indicators**: Moving averages, RSI, MACD, Bollinger Bands\n- **Seasonal Features**: Month, week, harvest seasons, holidays\n- **Weather Features**: Temperature, rainfall, humidity correlations\n- **Regional Features**: Cross-regional price comparisons\n- **Lag Features**: Historical price patterns\n\n## üìä Monitoring & Observability\n\n### Health Checks\n\n```bash\n# Service health\nGET /health\n\n# Service statistics\nGET /api/v1/stats\n```\n\n### MLflow Tracking\n\n- **Experiments**: Model training experiments\n- **Metrics**: MAE, RMSE, MAPE, R¬≤\n- **Artifacts**: Model files, training plots\n- **Parameters**: Hyperparameters, configurations\n\n### Prometheus Metrics\n\n- Prediction latency\n- Model accuracy\n- Anomaly detection rate\n- Cache hit rate\n- Request throughput\n\n## üê≥ Docker Deployment\n\n### Development\n\n```bash\n# Start development environment\ndocker-compose up -d\n\n# Scale ML service\ndocker-compose up -d --scale ml-service=3\n\n# Development with Jupyter\ndocker-compose --profile development up -d\n```\n\n### Production\n\n```bash\n# Build production image\ndocker build --target production -t komoditas-ml-service:latest .\n\n# Run production container\ndocker run -d \\\n  --name komoditas-ml \\\n  -p 8001:8001 \\\n  -e DATABASE_URL=postgresql://... \\\n  -e REDIS_URL=redis://... \\\n  komoditas-ml-service:latest\n```\n\n### Monitoring Stack\n\n```bash\n# Start with monitoring\ndocker-compose --profile monitoring up -d\n\n# Access interfaces\n# Grafana: http://localhost:3001 (admin/admin123)\n# Prometheus: http://localhost:9090\n# MLflow: http://localhost:5000\n```\n\n## üß™ Testing\n\n### Unit Tests\n\n```bash\n# Run unit tests\npytest tests/unit/ -v\n\n# Run with coverage\npytest tests/unit/ --cov=app --cov-report=html\n```\n\n### Integration Tests\n\n```bash\n# Run integration tests\npytest tests/integration/ -v\n\n# Test specific endpoint\npytest tests/integration/test_predictions.py::test_predict_price -v\n```\n\n### Load Testing\n\n```bash\n# Install locust\npip install locust\n\n# Run load tests\nlocust -f tests/load/locustfile.py --host=http://localhost:8001\n```\n\n## üìà Performance Optimization\n\n### Prediction Latency\n\n- **Target**: <100ms per prediction\n- **Caching**: Redis untuk hasil prediksi\n- **Model Loading**: Lazy loading dengan memory cache\n- **Batch Processing**: Concurrent predictions\n\n### Model Accuracy\n\n- **Target**: >85% untuk 7-day forecasts\n- **Ensemble Methods**: Kombinasi Prophet + LSTM\n- **Feature Selection**: Automated feature importance\n- **Hyperparameter Tuning**: Optuna optimization\n\n### Anomaly Detection\n\n- **Target**: >90% precision\n- **Multi-algorithm**: Temporal + Geographic detection\n- **Adaptive Thresholds**: Dynamic sensitivity adjustment\n- **Real-time Processing**: Streaming anomaly detection\n\n## üîÑ Data Pipeline\n\n### Data Sources Integration\n\n1. **Price Data**: PostgreSQL timeseries\n2. **Weather Data**: BMKG API integration\n3. **Feature Store**: Redis cached features\n4. **External APIs**: BPS, Panel Harga Pangan\n\n### Feature Engineering Pipeline\n\n```python\nfrom app.features.engineering import FeatureEngineer\n\n# Initialize feature engineer\nfe = FeatureEngineer()\n\n# Engineer features\nfeatures_df = fe.engineer_features(\n    price_data=price_data,\n    weather_data=weather_data,\n    commodity_code=\"BERAS\"\n)\n\n# Get feature summary\nsummary = fe.create_feature_summary(features_df)\n```\n\n## üö® Error Handling\n\n### Common Issues\n\n#### Database Connection\n```python\n# Check database health\nGET /health\n# Response: {\"database\": false}\n\n# Solution: Verify DATABASE_URL and postgres service\n```\n\n#### Model Not Found\n```python\n# Error: Model not found for commodity BERAS\n# Solution: Train model first\nPOST /api/v1/models/retrain\n{\n    \"model_name\": \"prophet\",\n    \"commodity_codes\": [\"BERAS\"]\n}\n```\n\n#### Prediction Timeout\n```python\n# Error: Prediction timeout\n# Solution: Check model loading and data availability\n# Reduce horizon_days or simplify features\n```\n\n## üîê Security\n\n### Authentication\n\n- JWT token validation\n- Rate limiting per IP\n- Request size limits\n- CORS configuration\n\n### Data Protection\n\n- Environment variable encryption\n- Database connection security\n- Redis AUTH (if configured)\n- Container security scanning\n\n## üìö Development Guidelines\n\n### Code Style\n\n```bash\n# Format code\nblack app/\nisort app/\n\n# Lint code\nflake8 app/\nmypy app/\n```\n\n### Contributing\n\n1. Fork repository\n2. Create feature branch\n3. Add tests\n4. Run quality checks\n5. Submit pull request\n\n### Project Structure\n\n```\nkomoditas-ml-service/\n‚îú‚îÄ‚îÄ app/\n‚îÇ   ‚îú‚îÄ‚îÄ api/              # FastAPI application\n‚îÇ   ‚îú‚îÄ‚îÄ models/           # ML models (Prophet, LSTM, etc.)\n‚îÇ   ‚îú‚îÄ‚îÄ training/         # Training pipeline\n‚îÇ   ‚îú‚îÄ‚îÄ inference/        # Prediction service\n‚îÇ   ‚îú‚îÄ‚îÄ features/         # Feature engineering\n‚îÇ   ‚îú‚îÄ‚îÄ preprocessing/    # Data preprocessing\n‚îÇ   ‚îî‚îÄ‚îÄ config/           # Configuration\n‚îú‚îÄ‚îÄ data/\n‚îÇ   ‚îú‚îÄ‚îÄ models/           # Trained model files\n‚îÇ   ‚îú‚îÄ‚îÄ artifacts/        # Model artifacts\n‚îÇ   ‚îî‚îÄ‚îÄ features/         # Feature store\n‚îú‚îÄ‚îÄ tests/\n‚îÇ   ‚îú‚îÄ‚îÄ unit/             # Unit tests\n‚îÇ   ‚îî‚îÄ‚îÄ integration/      # Integration tests\n‚îú‚îÄ‚îÄ docker/               # Docker configurations\n‚îî‚îÄ‚îÄ docs/                 # Documentation\n```\n\n## ü§ù Support\n\n### Documentation\n\n- **API Docs**: http://localhost:8001/docs\n- **Redoc**: http://localhost:8001/redoc\n- **Health Check**: http://localhost:8001/health\n\n### Troubleshooting\n\n1. **Check Logs**: `docker-compose logs ml-service`\n2. **Health Status**: `curl http://localhost:8001/health`\n3. **Database**: `docker-compose exec postgres psql -U postgres komoditas_watch`\n4. **Redis**: `docker-compose exec redis redis-cli`\n\n### Contact\n\n- **Technical Issues**: Create GitHub issue\n- **Feature Requests**: Discussion board\n- **Security Issues**: security@komoditaswatch.id\n\n## üìÑ License\n\nMIT License - see [LICENSE](LICENSE) file for details.\n\n---\n\n**Built with ‚ù§Ô∏è for Indonesian commodity market transparency**\n